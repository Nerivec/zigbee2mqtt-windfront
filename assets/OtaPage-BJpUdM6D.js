import{r,u as O,ad as L,j as s,F as N,ae as P,B as q,f as T,af as U,a as I,A as E,s as F,q as B,S as G,v as H,L as V,t as D,N as K,a5 as $,M as J}from"./index-DTLwKrFY.js";import{D as Q}from"./DeviceImage-CmmMipdr.js";import{I as W}from"./IndeterminateCheckbox-BxTDVPe-.js";import{O as w,a as X,f as M,b as Y}from"./OtaControlGroup-CoW_wL2h.js";import{u as Z,g as ee,d as se,c as te,e as ae,F as ne,f as ie,o as oe,a as re,s as le,b as de}from"./floating-ui.react-ey6TW0xJ.js";import{C as ce}from"./CheckboxField-C_Qtx-pp.js";import{D as me}from"./Duration-_uYoh7tk.js";import{T as ue}from"./Table-DKmoVF1a.js";import{u as fe,T as pe}from"./useTable-B9gY8JA0.js";import{M as he,V as ge}from"./VendorLink-BZlqzmcf.js";import{P as be}from"./PowerSource-BtLGM0pk.js";import"./envs-CRUy-_iG.js";import"./index-yG0-fBDW.js";import"./defineProperty-CegpTSss.js";import"./InputField-fj8dQezf.js";import"./SelectField-Hd9BNgRL.js";import"./floating-ui.dom-BSrWR8Gl.js";import"./DebouncedInput-CTO5Z9WE.js";import"./snakeCase-48ho8VHI.js";import"./_createCompounder-Jh3GrmJ6.js";import"./isObjectLike-BK6keKbA.js";const _e=r.memo(({sourceIdx:c,device:l,state:n,otaSettings:a,onUpdateClick:m,onScheduleClick:_})=>{const{t:h}=O(["ota","common"]),f=l.interview_state===L.InProgress||l.interview_state===L.Pending||n.state==="updating",[x,y]=r.useState(!1),[u,j]=r.useState({}),v=r.useRef(null),[C,g]=r.useState(!1),{refs:k,floatingStyles:S,context:b}=Z({open:C,onOpenChange:g,middleware:[oe(4),re({padding:16,crossAxis:!0}),le({padding:16,crossAxis:!0}),de({element:v})]}),e=ee(b,{event:"click"}),t=se(b),i=te(b),{getReferenceProps:o,getFloatingProps:p}=ae([e,t,i]),R=r.useCallback(async d=>{if(n.latest_version&&n.installed_version&&n.latest_source){g(!1);const A=n.latest_version<n.installed_version;switch(d){case"update":{const z={sourceIdx:c,ieee:l.ieee_address,downgrade:A,url:n.latest_source};u.image_block_request_timeout&&(z.image_block_request_timeout=u.image_block_request_timeout),u.image_block_response_delay&&(z.image_block_response_delay=u.image_block_response_delay),u.default_maximum_data_size&&(z.default_maximum_data_size=u.default_maximum_data_size),await m(z);break}case"schedule":{await _({sourceIdx:c,ieee:l.ieee_address,downgrade:A,url:n.latest_source});break}}}},[c,l.ieee_address,u,n,m,_]);return s.jsxs(s.Fragment,{children:[s.jsx("button",{ref:k.setReference,type:"button",className:`btn btn-sm btn-square btn-outline ${n.latest_version>n.installed_version?"btn-accent":"btn-error"} join-item tooltip tooltip-top`,...o(),"data-tip":h(d=>d.update),disabled:f,children:s.jsx(N,{icon:P})}),C?s.jsx(ne,{children:s.jsxs("aside",{ref:k.setFloating,style:S,...p({className:"card bg-base-200 shadow-lg border border-base-300 w-[min(32rem,calc(100vw-2.5rem))] max-h-[90vh] z-11"}),children:[s.jsxs("div",{className:"card-body py-2 w-full h-full overflow-hidden",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsxs("h4",{className:"card-title",children:["OTA: ",l.friendly_name]}),s.jsx(q,{onClick:()=>g(!1),className:"btn btn-ghost btn-square",children:s.jsx(N,{icon:T})})]}),s.jsxs("div",{className:"flex flex-col gap-2 w-full h-full overflow-y-auto",children:[s.jsxs("div",{className:"flex flex-col w-full gap-2",children:[s.jsx("ul",{className:"steps steps-horizontal w-full mb-2",children:n.latest_version>n.installed_version?s.jsxs(s.Fragment,{children:[s.jsx("li",{className:"step step-neutral","data-content":"●",children:s.jsx(w,{version:n.installed_version,showRaw:!0})}),s.jsx("li",{className:"step step-accent","data-content":"★",children:s.jsx(w,{version:n.latest_version,showRaw:!0})})]}):s.jsxs(s.Fragment,{children:[s.jsx("li",{className:"step step-error","data-content":"★",children:s.jsx(w,{version:n.latest_version,showRaw:!0})}),s.jsx("li",{className:"step step-neutral","data-content":"●",children:s.jsx(w,{version:n.installed_version,showRaw:!0})})]})}),s.jsxs("p",{children:[h(d=>d.source),": "]}),s.jsx("div",{className:"wrap-anywhere",children:s.jsx("p",{className:"text-base-content/65",children:n.latest_source})}),s.jsxs("p",{children:[h(d=>d.release_notes),": "]}),s.jsx("div",{className:"wrap-anywhere",children:s.jsx("p",{className:"text-base-content/65",children:n.latest_release_notes??"N/A"})})]}),s.jsx(ce,{name:"show_update_settings",label:h(d=>d.show_update_settings),checked:x,onChange:d=>y(d.target.checked)}),x?s.jsx(X,{settings:u,setSettings:j,defaultSettings:a}):null]}),s.jsxs("div",{className:"card-actions justify-end py-2",children:[s.jsx(q,{className:"btn btn-square btn-outline btn-error join-item",onClick:R,item:"update",title:h(d=>d.update),children:s.jsx(N,{icon:P})}),s.jsx(q,{className:"btn btn-square btn-outline btn-info join-item",onClick:R,item:"schedule",title:h(d=>d.schedule),children:s.jsx(N,{icon:U})})]})]}),s.jsx(ie,{ref:v,context:b,className:"fill-base-200 [&>path:first-of-type]:stroke-base-300 [&>path:last-of-type]:stroke-base-300"})]})}):null]})}),xe=({label:c,remaining:l,progress:n})=>l&&l>0?s.jsxs(s.Fragment,{children:[s.jsx("progress",{className:"progress",value:n,max:"100"}),s.jsxs("div",{children:[c," ",s.jsx(me,{durationSec:l})]})]}):s.jsx("progress",{className:"progress",value:n,max:"100"}),we=r.memo(({device:c})=>{const{t:l}=O("zigbee");let n="https://github.com/Koenkk/zigbee-OTA/releases";const a=c.software_build_id||l(m=>m.unknown);switch(c?.definition?.vendor){case"IKEA":n="https://ww8.ikea.com/ikeahomesmart/releasenotes/releasenotes.html";break;case"Inovelli":n="https://help.inovelli.com/en/articles/8503774-what-is-the-latest-firmware-version-for-your-device#h_b74c1e7dc6";break;case"Philips":n=`https://www.philips-hue.com/en-us/support/release-notes/${c.definition?.exposes.find(m=>m.type==="light")?"lamps":"accessories"}`;break;case"Ubisys":n=`https://www.ubisys.de/en/support/firmware/change-logs-${c.definition?.model?.replace(/[-]/g,"").toLowerCase()}/`;break}return s.jsx("a",{target:"_blank",rel:"noopener noreferrer",href:n,className:"link link-hover",children:a})});function Ue(){const c=I(e=>e.devices),l=I(e=>e.deviceStates),n=I(e=>e.bridgeInfo),{t:a}=O(["ota","zigbee","common"]),[m,_]=r.useState({});r.useEffect(()=>{_({})},[c]);const h=r.useMemo(()=>{const e=[];for(let t=0;t<E.length;t++){const i=n[t].config.ota;for(const o of c[t])if(o.definition?.supports_ota&&!o.disabled){const p=l[t][o.friendly_name]??{};e.push({sourceIdx:t,device:o,state:p.update,batteryState:o.power_source==="Battery"?{batteryPercent:p.battery,batteryState:p.battery_state,batteryLow:p.battery_low}:void 0,otaSettings:i})}}return e},[l,c,n]),f=r.useMemo(()=>Object.keys(m).length,[m]),x=r.useCallback(async e=>{const t=[];for(const i of g.getFilteredRowModel().rows)if(i.getIsSelected()){const{sourceIdx:o,device:p}=i.original;t.push(F(o,e,{id:p.ieee_address}))}_({}),t.length>0&&await Promise.allSettled(t)},[]),y=r.useCallback(async({sourceIdx:e,ieee:t,downgrade:i,...o})=>await F(e,i?"bridge/request/device/ota_update/check/downgrade":"bridge/request/device/ota_update/check",{id:t,...o}),[]),u=r.useCallback(async({sourceIdx:e,ieee:t,downgrade:i,...o})=>await F(e,i?"bridge/request/device/ota_update/update/downgrade":"bridge/request/device/ota_update/update",{id:t,...o}),[]),j=r.useCallback(async({sourceIdx:e,ieee:t,downgrade:i,...o})=>await F(e,i?"bridge/request/device/ota_update/schedule/downgrade":"bridge/request/device/ota_update/schedule",{id:t,...o}),[]),v=r.useCallback(async({sourceIdx:e,ieee:t})=>await F(e,"bridge/request/device/ota_update/unschedule",{id:t}),[]),C=r.useMemo(()=>[{id:"select",size:45,header:({table:e})=>s.jsx(W,{checked:e.getIsAllRowsSelected(),indeterminate:e.getIsSomeRowsSelected(),onChange:e.getToggleAllRowsSelectedHandler()}),accessorFn:()=>"",cell:({row:e})=>s.jsx("input",{type:"checkbox",className:"checkbox",checked:e.getIsSelected(),disabled:!e.getCanSelect(),onChange:e.getToggleSelectedHandler()}),enableGlobalFilter:!1,enableColumnFilter:!1,enableSorting:!1},{id:"source",size:60,header:()=>s.jsx("span",{title:a(e=>e.source,{ns:"common"}),children:s.jsx(N,{icon:H})}),accessorFn:({sourceIdx:e})=>B[e],cell:({row:{original:{sourceIdx:e}}})=>s.jsx(G,{idx:e,nameClassName:"hidden md:inline-block"}),filterFn:"equals",meta:{filterVariant:"select",showFacetedOccurrences:!0}},{id:"friendly_name",size:250,minSize:175,header:a(e=>e.friendly_name,{ns:"common"}),accessorFn:({device:e})=>`${e.friendly_name} ${e.description??""} ${e.ieee_address}`,cell:({row:{original:{sourceIdx:e,device:t,state:i,batteryState:o}}})=>s.jsxs("div",{className:"flex items-center gap-3",children:[s.jsx("div",{className:"avatar",children:s.jsx("div",{className:"h-11 w-11",style:{overflow:"visible"},children:s.jsx(Q,{device:t,otaState:i?.state,disabled:!1})})}),s.jsxs("div",{className:"flex-grow flex flex-col min-w-0",children:[s.jsx(V,{to:`/device/${e}/${t.ieee_address}/info`,className:"link link-hover truncate",children:t.friendly_name}),t.description&&s.jsx("div",{className:"max-w-3xs text-xs opacity-50 truncate",title:t.description,children:t.description}),s.jsx("div",{className:"flex flex-row gap-1 mt-0.5 items-center",children:o&&s.jsx("span",{className:"badge badge-sm badge-soft badge-ghost cursor-default",children:s.jsx(be,{device:t,...o,showLevel:!0})})})]})]}),sortingFn:(e,t)=>e.original.device.friendly_name.localeCompare(t.original.device.friendly_name),filterFn:"includesString",meta:{filterVariant:"text",textFaceted:!0}},{id:"ieee_address",minSize:175,header:a(e=>e.ieee_address,{ns:"zigbee"}),accessorFn:({device:e})=>`${e.ieee_address} ${D(e.network_address,4)} ${e.network_address}`,cell:({row:{original:{sourceIdx:e,device:t}}})=>s.jsxs(s.Fragment,{children:[s.jsx("div",{children:s.jsx(V,{to:`/device/${e}/${t.ieee_address}/info`,className:"link link-hover font-mono",children:t.ieee_address})}),s.jsxs("div",{className:"flex flex-row gap-1",children:[s.jsx("span",{className:"badge badge-ghost badge-sm cursor-default font-mono",title:a(i=>i.network_address_hex,{ns:"zigbee"}),children:D(t.network_address,4)}),s.jsx("span",{className:"badge badge-ghost badge-sm cursor-default font-mono",title:a(i=>i.network_address_dec,{ns:"zigbee"}),children:t.network_address})]})]}),sortingFn:(e,t)=>e.original.device.ieee_address.localeCompare(t.original.device.ieee_address),filterFn:"includesString",meta:{filterVariant:"text"}},{id:"model",minSize:175,header:a(e=>e.model,{ns:"zigbee"}),accessorFn:({device:e})=>`${e.definition?.model??""} ${e.model_id??""} ${e.definition?.vendor??e.manufacturer??""}`,cell:({row:{original:{device:e}}})=>s.jsxs(s.Fragment,{children:[s.jsx(he,{modelId:e.model_id,supported:e.supported,definitionModel:e.definition?.model,definitionVendor:e.definition?.vendor}),s.jsx("div",{children:s.jsx("span",{className:"badge badge-sm badge-ghost tooltip tooltip-bottom","data-tip":a(t=>t.manufacturer,{ns:"zigbee"}),children:s.jsx(ge,{supported:e.supported,definitionVendor:e.definition?.vendor})})})]}),filterFn:"includesString",meta:{filterVariant:"text",textFaceted:!0,showFacetedOccurrences:!0}},{id:"firmware_id",minSize:175,header:a(e=>e.firmware_id,{ns:"zigbee"}),accessorFn:({device:e})=>`${e.software_build_id??""} ${e.date_code??""}`,cell:({row:{original:{device:e}}})=>s.jsxs(s.Fragment,{children:[s.jsx(we,{device:e}),e.date_code&&s.jsx("div",{children:s.jsx("span",{className:"badge badge-sm badge-ghost tooltip tooltip-bottom","data-tip":a(t=>t.firmware_build_date,{ns:"zigbee"}),children:e.date_code})})]}),filterFn:"includesString",meta:{filterVariant:"text"}},{id:"firmware_version",minSize:175,header:a(e=>e.firmware_version),accessorFn:({state:e})=>M(e?.installed_version)?.join(" "),cell:({row:{original:{state:e}}})=>s.jsx(w,{version:e?.installed_version}),filterFn:"includesString",meta:{filterVariant:"text"}},{id:"available_firmware_version",minSize:175,header:a(e=>e.available_firmware_version),accessorFn:({state:e})=>M(e?.latest_version)?.join(" "),cell:({row:{original:{state:e}}})=>s.jsx(w,{version:e?.latest_version}),filterFn:"includesString",meta:{filterVariant:"text"}},{id:"state",header:a(e=>e.state,{ns:"common"}),accessorFn:({state:e})=>e?.state?a(t=>t[e.state]):a(t=>t.unknown,{ns:"zigbee"}),filterFn:"equals",meta:{filterVariant:"select"}},{id:"actions",header:"",minSize:130,accessorFn:({state:e})=>e?.state,cell:({row:{original:{sourceIdx:e,device:t,state:i,otaSettings:o}}})=>i?.state==="updating"?s.jsx(xe,{label:a(p=>p.remaining_time),remaining:i.remaining,progress:i.progress}):s.jsxs("div",{className:"join join-horizontal",children:[s.jsx(Y,{sourceIdx:e,device:t,state:i,otaSettings:o,onCheckClick:y,onUpdateClick:u,onScheduleClick:j,onUnscheduleClick:v}),i?.state==="available"?s.jsx(_e,{sourceIdx:e,device:t,state:i,otaSettings:o,onUpdateClick:u,onScheduleClick:j}):null]}),enableSorting:!1,enableColumnFilter:!1,enableGlobalFilter:!1}],[y,u,j,v,a]),{table:g,resetFilters:k,globalFilter:S,columnFilters:b}=fe({id:"ota-devices",columns:C,data:h,visibleColumns:{source:J,state:!1},sorting:[{id:"friendly_name",desc:!1}],rowSelection:m,onRowSelectionChange:_});return r.useEffect(()=>{const e=new Set;for(const o of g.getFilteredRowModel().rows)e.add(o.id);let t=!1;const i={};for(const o in m)e.has(o)?i[o]=!0:t=!0;t&&_(i)},[g,m,h,S,b]),s.jsxs(s.Fragment,{children:[s.jsx(K,{children:s.jsx(pe,{table:g,resetFilters:k,globalFilter:S,columnFilters:b})}),s.jsxs("div",{className:"mb-5",children:[s.jsxs("div",{className:"flex flex-row flex-wrap gap-2 px-2 pb-3",children:[s.jsx($,{className:"btn btn-outline btn-error btn-sm",item:"bridge/request/device/ota_update/check",onClick:x,title:a(e=>e.check_selected),modalDescription:a(e=>e.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:a(e=>e.cancel,{ns:"common"}),disabled:f===0,children:`${a(e=>e.check_selected)} (${f})`}),s.jsx($,{className:"btn btn-outline btn-error btn-sm",item:"bridge/request/device/ota_update/update",onClick:x,title:a(e=>e.update_selected),modalDescription:a(e=>e.update_selected_info),modalCancelLabel:a(e=>e.cancel,{ns:"common"}),disabled:f===0,children:`${a(e=>e.update_selected)} (${f})`}),s.jsx($,{className:"btn btn-outline btn-error btn-sm",item:"bridge/request/device/ota_update/schedule",onClick:x,title:a(e=>e.schedule_selected),modalDescription:a(e=>e.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:a(e=>e.cancel,{ns:"common"}),disabled:f===0,children:`${a(e=>e.schedule_selected)} (${f})`}),s.jsx($,{className:"btn btn-outline btn-error btn-sm",item:"bridge/request/device/ota_update/unschedule",onClick:x,title:a(e=>e.unschedule_selected),modalDescription:a(e=>e.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:a(e=>e.cancel,{ns:"common"}),disabled:f===0,children:`${a(e=>e.unschedule_selected)} (${f})`})]}),s.jsx(ue,{id:"ota-devices",table:g,resetFilters:k,globalFilter:S,columnFilters:b})]})]})}export{Ue as default};
