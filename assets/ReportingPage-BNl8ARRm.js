import{Y as k,a2 as G,u as V,r as s,j as t,a3 as H,B as C,a as P,A as X,s as E,a7 as Z,q as B,S as ee,F,v as te,L as ne,a8 as ae,a5 as I,a9 as ie,c as se,N as re,M as O}from"./index-DTLwKrFY.js";import{D as le}from"./DeviceImage-CmmMipdr.js";import{i as oe,R as U,m as ce}from"./ReportingRow-DIICINVc.js";import{S as de}from"./SelectField-Hd9BNgRL.js";import{I as M}from"./InputField-fj8dQezf.js";import{I as me}from"./IndeterminateCheckbox-BxTDVPe-.js";import{D as ue}from"./DevicePicker-BoDg6RDG.js";import{E as pe}from"./EndpointPicker-BBdFdL_6.js";import{g as $,i as z}from"./ClusterSinglePicker-DpCdk6e3.js";import{T as be}from"./Table-DKmoVF1a.js";import{u as ge,T as fe}from"./useTable-B9gY8JA0.js";import"./envs-CRUy-_iG.js";import"./index-yG0-fBDW.js";import"./defineProperty-CegpTSss.js";import"./react-select.esm-Bdw18Log.js";import"./extends-CF3RwP-h.js";import"./floating-ui.dom-BSrWR8Gl.js";import"./DebouncedInput-CTO5Z9WE.js";const ve=k.create(({onApply:f})=>{const o=G(),{t:n}=V(["zigbee","common","devicePage"]),[c,j]=s.useState(""),[r,m]=s.useState(""),[u,x]=s.useState(null),p=s.useCallback(async()=>{await f([c,r,u??0,!1]),o.remove()},[f,o,c,r,u]);s.useEffect(()=>{const i=N=>{N.key==="Escape"&&(N.preventDefault(),o.remove())};return window.addEventListener("keydown",i),()=>window.removeEventListener("keydown",i)},[o]);const h=s.useMemo(()=>oe(c,r,u),[c,r,u]);return t.jsxs(H,{isOpen:o.visible,title:n(i=>i.reporting,{ns:"devicePage"}),footer:t.jsxs(t.Fragment,{children:[t.jsx(C,{className:"btn btn-neutral",onClick:o.remove,children:n(i=>i.cancel,{ns:"common"})}),t.jsx(C,{title:n(i=>i.apply,{ns:"common"}),className:"btn btn-primary ms-1",onClick:p,disabled:!h,children:n(i=>i.apply,{ns:"common"})})]}),children:[t.jsx(M,{name:"minimum_report_interval",label:n(i=>i.min_rep_interval),type:"number",defaultValue:c??"",onChange:i=>j(i.target.value?i.target.valueAsNumber:""),required:!0,className:"input validator",min:0,max:65535}),t.jsx(M,{name:"maximum_report_interval",label:n(i=>i.max_rep_interval),type:"number",defaultValue:r??"",onChange:i=>m(i.target.value?i.target.valueAsNumber:""),required:!0,className:"input validator",min:0,max:65535}),t.jsx(M,{name:"reportable_change",label:n(i=>i.min_rep_change),type:"number",defaultValue:u??"",onChange:i=>x(i.target.value?i.target.valueAsNumber:null),className:"input validator"})]})}),xe=k.create(({sourceIdx:f,device:o,rule:n,onApply:c,bridgeDefinitions:j,isAnalogAttribute:r})=>{const m=G(),{t:u}=V(["common","devicePage"]),x=s.useCallback(async p=>{await c(f,o,p,r),m.remove()},[f,o,r,c,m]);return s.useEffect(()=>{const p=h=>{h.key==="Escape"&&(h.preventDefault(),m.remove())};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[m]),t.jsx(H,{isOpen:m.visible,title:`${u(p=>p.reporting,{ns:"devicePage"})}: ${o.friendly_name} (${n.endpoint})`,footer:t.jsx(C,{className:"btn btn-neutral",onClick:m.remove,children:u(p=>p.cancel)}),children:t.jsx(U,{sourceIdx:f,rule:n,bridgeDefinitions:j,device:o,onApply:x,showDivider:!1,showOnlyApply:!0})})});function Ve(){const f=P(e=>e.bridgeDefinitions),o=P(e=>e.devices),{t:n}=V(["zigbee","common"]),[c,j]=s.useState(0),[r,m]=s.useState(null),[u,x]=s.useState(""),[p,h]=s.useState(null),[i,N]=s.useState({});s.useEffect(()=>{N({})},[o]);const Y=s.useMemo(()=>{const e=[];for(let a=0;a<X.length;a++){const d=f[a];for(const b of o[a])for(const g in b.endpoints){const l=b.endpoints[g];for(const _ of l.configured_reportings){const w=$(d,b.ieee_address,_.cluster,_.attribute),v=w==null||z(w);e.push({sourceIdx:a,device:b,rule:{..._,endpoint:g},bridgeDefinitions:d,isAnalogAttribute:v})}}}return e},[o,f]),R=s.useMemo(()=>Object.keys(i).length,[i]),q=s.useCallback(async([e,a,d,b])=>{const g=[];for(const l of D.table.getFilteredRowModel().rows)if(l.getIsSelected()){const{sourceIdx:_,device:w,rule:v,bridgeDefinitions:A}=l.original,S=$(A,w.ieee_address,v.cluster,v.attribute),W=S==null||z(S),L={id:w.ieee_address,endpoint:v.endpoint,cluster:v.cluster,attribute:v.attribute,minimum_report_interval:e===void 0?v.minimum_report_interval:e,maximum_report_interval:b?65535:a===void 0?v.maximum_report_interval:a,option:{}};W&&(L.reportable_change=b?0:d===void 0?v.reportable_change:d),g.push(E(_,"bridge/request/device/reporting/configure",L))}N({}),g.length>0&&await Promise.allSettled(g)},[]);s.useEffect(()=>{h(r&&u?ce(r.ieee_address,u):null)},[r,u]);const J=s.useMemo(()=>Z(r),[r]),y=s.useCallback(async(e,a,d,b)=>{const{cluster:g,endpoint:l,attribute:_,minimum_report_interval:w,maximum_report_interval:v,reportable_change:A}=d,S={id:a.ieee_address,endpoint:l,cluster:g,attribute:_,minimum_report_interval:w,maximum_report_interval:v,option:{}};b&&(S.reportable_change=A),await E(e,"bridge/request/device/reporting/configure",S)},[]),K=s.useCallback(async e=>{if(!r)return;const a=$(f[c],r.ieee_address,e.cluster,e.attribute),d=a==null||z(a);await y(c,r,e,d),j(0),m(null),x("")},[y,c,r,f]),T=s.useCallback(async([e,a,d,b,g])=>{await E(e,"bridge/request/device/reporting/read",{id:a,endpoint:d,cluster:b,configs:[{attribute:g}]})},[]),Q=s.useMemo(()=>[{id:"select",size:45,header:({table:e})=>t.jsx(me,{checked:e.getIsAllRowsSelected(),indeterminate:e.getIsSomeRowsSelected(),onChange:e.getToggleAllRowsSelectedHandler()}),accessorFn:()=>"",cell:({row:e})=>t.jsx("input",{type:"checkbox",className:"checkbox",checked:e.getIsSelected(),disabled:!e.getCanSelect(),onChange:e.getToggleSelectedHandler()}),enableGlobalFilter:!1,enableColumnFilter:!1,enableSorting:!1},{id:"source",size:60,header:()=>t.jsx("span",{title:n(e=>e.source,{ns:"common"}),children:t.jsx(F,{icon:te})}),accessorFn:({sourceIdx:e})=>B[e],cell:({row:{original:{sourceIdx:e}}})=>t.jsx(ee,{idx:e,nameClassName:"hidden md:inline-block"}),filterFn:"equals",meta:{filterVariant:"select",showFacetedOccurrences:!0}},{id:"friendly_name",size:250,minSize:175,header:n(e=>e.friendly_name,{ns:"common"}),accessorFn:({device:e})=>`${e.friendly_name} ${e.ieee_address} ${e.definition?.model??""}`,cell:({row:{original:{sourceIdx:e,device:a}}})=>t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"avatar",children:t.jsx("div",{className:"h-11 w-11",style:{overflow:"visible"},children:t.jsx(le,{device:a,disabled:a.disabled})})}),t.jsxs("div",{className:"flex-grow flex flex-col min-w-0",children:[t.jsx(ne,{to:`/device/${e}/${a.ieee_address}/reporting`,className:"link link-hover truncate",children:a.friendly_name}),a.description&&t.jsx("div",{className:"max-w-3xs text-xs opacity-50 truncate",title:a.description,children:a.description})]})]}),sortingFn:(e,a)=>e.original.device.friendly_name.localeCompare(a.original.device.friendly_name),filterFn:"includesString",meta:{filterVariant:"text",textFaceted:!0}},{id:"endpoint",size:85,header:n(e=>e.endpoint),accessorFn:({rule:e})=>e.endpoint,filterFn:"equals",meta:{filterVariant:"text"}},{id:"cluster",minSize:150,header:n(e=>e.cluster),accessorFn:({rule:e})=>e.cluster,cell:({row:{original:{rule:e}}})=>t.jsx("div",{className:"min-w-0",title:`${e.cluster}`,children:t.jsx("div",{className:"truncate",children:e.cluster})}),filterFn:"includesString",meta:{filterVariant:"text",textFaceted:!0}},{id:"attribute",minSize:150,header:n(e=>e.attribute),accessorFn:({rule:e})=>e.attribute,cell:({row:{original:{rule:e}}})=>t.jsx("div",{className:"min-w-0",title:`${e.attribute}`,children:t.jsx("div",{className:"truncate",children:e.attribute})}),filterFn:"includesString",meta:{filterVariant:"text",textFaceted:!0}},{id:"min_rep_interval",size:120,header:n(e=>e.min_rep_interval),accessorFn:({rule:e})=>e.minimum_report_interval,filterFn:"inNumberRange",meta:{filterVariant:"range"}},{id:"max_rep_interval",size:120,header:n(e=>e.max_rep_interval),accessorFn:({rule:e})=>e.maximum_report_interval,filterFn:"inNumberRange",meta:{filterVariant:"range"}},{id:"min_rep_change",size:120,header:n(e=>e.min_rep_change),accessorFn:({rule:e,isAnalogAttribute:a})=>a?e.reportable_change:"N/A",filterFn:"inNumberRange",meta:{filterVariant:"range"}},{id:"actions",size:110,cell:({row:{original:{sourceIdx:e,device:a,rule:d,bridgeDefinitions:b,isAnalogAttribute:g}}})=>t.jsxs("div",{className:"join join-horizontal",children:[t.jsx(C,{className:"btn btn-sm btn-square btn-outline btn-primary join-item",title:n(l=>l.edit,{ns:"common"}),onClick:async()=>await k.show(xe,{sourceIdx:e,device:a,rule:d,bridgeDefinitions:b,isAnalogAttribute:g,onApply:y}),children:t.jsx(F,{icon:ae})}),t.jsx(I,{className:"btn btn-sm btn-square btn-outline btn-accent join-item",item:[e,a.ieee_address,d.endpoint,d.cluster,d.attribute],onClick:T,title:n(l=>l.sync,{ns:"common"}),modalDescription:n(l=>l.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:n(l=>l.cancel,{ns:"common"}),children:t.jsx(F,{icon:ie})}),t.jsx(I,{title:n(l=>l.disable,{ns:"common"}),className:"btn btn-sm btn-square btn-error btn-outline join-item",onClick:async()=>await y(e,a,{...d,maximum_report_interval:65535,reportable_change:0},g),modalDescription:n(l=>l.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:n(l=>l.cancel,{ns:"common"}),children:t.jsx(F,{icon:se})})]}),enableSorting:!1,enableColumnFilter:!1,enableGlobalFilter:!1}],[y,T,n]),D=ge({id:"all-reportings",columns:Q,data:Y,visibleColumns:{source:O},sorting:[{id:"friendly_name",desc:!1},{id:"endpoint",desc:!1}],rowSelection:i,onRowSelectionChange:N});return t.jsxs(t.Fragment,{children:[t.jsx(re,{children:t.jsx(fe,{...D})}),t.jsxs("div",{className:"flex flex-row flex-wrap justify-center gap-2 mb-2",children:[O?t.jsx(de,{name:"source",label:n(e=>e.source,{ns:"common"}),value:c,onChange:e=>{e.target.validationMessage||(j(Number.parseInt(e.target.value,10)),m(null),x(""))},className:"select",children:B.map((e,a)=>t.jsx("option",{value:a,children:e},`${a}-${e}`))}):null,t.jsx(ue,{label:n(e=>e.device,{ns:"zigbee"}),devices:o[c]??[],value:r?.ieee_address??"",onChange:e=>{e&&"ieee_address"in e?(m(e),x("")):m(null)},disabled:(o[c]??[]).length===0}),t.jsx(pe,{label:n(e=>e.source_endpoint,{ns:"common"}),values:J,value:u,disabled:!r,onChange:e=>x(String(e))}),r&&p?t.jsx(U,{sourceIdx:c,rule:p,bridgeDefinitions:f[c],device:r,onApply:K,showDivider:!1}):null]}),t.jsx("div",{className:"mb-5",children:t.jsxs("div",{className:"flex flex-row flex-wrap gap-2 px-2 pb-3",children:[t.jsx(C,{className:"btn btn-outline btn-error btn-sm",title:n(e=>e.edit_selected,{ns:"common"}),onClick:async()=>await k.show(ve,{onApply:q}),disabled:R===0,children:`${n(e=>e.edit_selected,{ns:"common"})} (${R})`}),t.jsx(I,{item:[void 0,void 0,void 0,!0],className:"btn btn-outline btn-error btn-sm",onClick:q,title:n(e=>e.disable_selected,{ns:"common"}),disabled:R===0,modalDescription:n(e=>e.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:n(e=>e.cancel,{ns:"common"}),children:`${n(e=>e.disable_selected,{ns:"common"})} (${R})`})]})}),t.jsx("div",{className:"mb-5",children:t.jsx(be,{id:"all-reportings",...D})})]})}export{Ve as default};
