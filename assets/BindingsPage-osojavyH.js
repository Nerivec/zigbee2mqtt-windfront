import{Y as M,a2 as T,u as I,r as o,j as n,a3 as B,B as j,a as P,q as z,s as E,a7 as V,S as O,F as A,v as U,L as G,J as H,a5 as $,aa as J,N as Y,M as L}from"./index-DTLwKrFY.js";import{B as q,f as K,i as Q,C as W,a as X,m as Z,g as ee}from"./BindRow-CFlSbYVl.js";import{D as ne}from"./DeviceImage-CmmMipdr.js";import{S as se}from"./SelectField-Hd9BNgRL.js";import{I as te}from"./IndeterminateCheckbox-BxTDVPe-.js";import{D as ie}from"./DevicePicker-BoDg6RDG.js";import{E as ae}from"./EndpointPicker-BBdFdL_6.js";import{T as oe}from"./Table-DKmoVF1a.js";import{u as le,T as re}from"./useTable-B9gY8JA0.js";import"./envs-CRUy-_iG.js";import"./react-select.esm-Bdw18Log.js";import"./defineProperty-CegpTSss.js";import"./extends-CF3RwP-h.js";import"./floating-ui.dom-BSrWR8Gl.js";import"./index-yG0-fBDW.js";import"./DebouncedInput-CTO5Z9WE.js";const ce=M.create(({sourceIdx:d,device:m,devices:t,groups:c,rule:u,onApply:l})=>{const f=T(),{t:w}=I(["common","devicePage"]),v=o.useCallback(async p=>{await l(p),f.remove()},[f,l]);return o.useEffect(()=>{const p=_=>{_.key==="Escape"&&(_.preventDefault(),f.remove())};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[f]),n.jsx(B,{isOpen:f.visible,title:`${w(p=>p.bind,{ns:"devicePage"})}: ${m.friendly_name} (${u.source.endpoint})`,footer:n.jsx(j,{className:"btn btn-neutral",onClick:f.remove,children:w(p=>p.cancel)}),children:n.jsx(q,{sourceIdx:d,device:m,devices:t,groups:c,rule:u,onApply:v,showDivider:!1,hideUnbind:!0})})}),de=M.create(({devices:d,selectedRows:m,onApply:t})=>{const c=T(),{t:u}=I(["zigbee","common","devicePage"]),[l,f]=o.useState([]),w=o.useCallback(async()=>{Array.isArray(l)&&l.length>0&&(await t([!1,l]),c.remove())},[t,c,l]);o.useEffect(()=>{const a=b=>{b.key==="Escape"&&(b.preventDefault(),c.remove())};return window.addEventListener("keydown",a),()=>window.removeEventListener("keydown",a)},[c]);const v=o.useMemo(()=>{let a=new Set,b=!1;for(const D of m){const{original:{sourceIdx:x,rule:S,device:N}}=D,{target:k}=S,y=k.type==="group"?void 0:d[x].find(R=>R.ieee_address===k.ieee_address),F=K(S,N.endpoints,y);if(!b){a=F,b=!0;continue}a=a.intersection(F)}return a},[m,d]),p=o.useMemo(()=>{const a=m[0]?.original.rule.target.type;return m.some(b=>b.original.rule.target.type!==a)},[m]),_=o.useMemo(()=>Q(l),[l]);return p?n.jsx(B,{isOpen:c.visible,title:u(a=>a.bind,{ns:"devicePage"}),footer:n.jsx(j,{className:"btn btn-neutral",onClick:c.remove,children:u(a=>a.cancel,{ns:"common"})}),children:u(a=>a.mismatching_types,{ns:"common"})}):n.jsx(B,{isOpen:c.visible,title:u(a=>a.bind,{ns:"devicePage"}),footer:n.jsxs(n.Fragment,{children:[n.jsx(j,{className:"btn btn-neutral",onClick:c.remove,children:u(a=>a.cancel,{ns:"common"})}),n.jsx(j,{title:u(a=>a.apply,{ns:"common"}),className:"btn btn-primary ms-1",onClick:w,disabled:!_,children:u(a=>a.apply,{ns:"common"})})]}),children:n.jsx(W,{label:u(a=>a.clusters,{ns:"common"}),clusters:v,value:l??[],onChange:f})})});function ke(){const d=P(e=>e.devices),m=P(e=>e.groups),{t}=I(["zigbee","common"]),[c,u]=o.useState(0),[l,f]=o.useState(null),[w,v]=o.useState(""),[p,_]=o.useState(null),[a,b]=o.useState({});o.useEffect(()=>{b({})},[d]);const D=o.useMemo(()=>{const e=[];for(let s=0;s<z.length;s++){const r=d[s]??[];for(const i of r)for(const h of X(i))e.push({sourceIdx:s,device:i,rule:h})}return e},[d]),x=o.useMemo(()=>Object.keys(a).length,[a]),S=o.useCallback(async([e,s])=>{const r=[];for(const i of C.table.getFilteredRowModel().rows)if(i.getIsSelected()){const{sourceIdx:h,rule:g}=i.original;r.push(E(h,e?"bridge/request/device/unbind":"bridge/request/device/bind",{from:g.source.ieee_address,from_endpoint:g.source.endpoint,to:g.target.type==="group"?g.target.id:g.target.ieee_address,to_endpoint:g.target.type==="endpoint"?g.target.endpoint:void 0,clusters:s??g.clusters}))}b({}),r.length>0&&await Promise.allSettled(r)},[d,m]),N=o.useCallback(async e=>{const s=[],r=new Set;for(const i of C.table.getFilteredRowModel().rows)if(i.getIsSelected()){const{sourceIdx:h,device:g}=i.original;if(r.has(g.ieee_address))continue;r.add(g.ieee_address),s.push(E(h,"bridge/request/device/binds/clear",{target:g.ieee_address,ieee_list:[e?"0xffffffffffffffff":g.ieee_address]}))}b({}),s.length>0&&await Promise.allSettled(s)},[]),k=o.useMemo(()=>V(l),[l]);o.useEffect(()=>{_(l&&w?Z(l.ieee_address,w):null)},[w,l]);const y=o.useCallback(async(e,s,r)=>{const i=ee(r.target,d[e],m[e]);if(!i)return;const h={from:r.source.ieee_address,from_endpoint:r.source.endpoint,to:i.to,to_endpoint:i.toEndpoint,clusters:r.clusters};s==="Bind"?await E(e,"bridge/request/device/bind",h):await E(e,"bridge/request/device/unbind",h)},[d,m]),F=o.useCallback(async([e,s])=>{l&&(await y(c,e,s),u(0),f(null),v(""))},[y,c,l]),R=o.useMemo(()=>[{id:"select",size:45,header:({table:e})=>n.jsx(te,{checked:e.getIsAllRowsSelected(),indeterminate:e.getIsSomeRowsSelected(),onChange:e.getToggleAllRowsSelectedHandler()}),accessorFn:()=>"",cell:({row:e})=>n.jsx("input",{type:"checkbox",className:"checkbox",checked:e.getIsSelected(),disabled:!e.getCanSelect(),onChange:e.getToggleSelectedHandler()}),enableGlobalFilter:!1,enableColumnFilter:!1,enableSorting:!1},{id:"source",size:60,header:()=>n.jsx("span",{title:t(e=>e.source,{ns:"common"}),children:n.jsx(A,{icon:U})}),accessorFn:({sourceIdx:e})=>z[e],cell:({row:{original:{sourceIdx:e}}})=>n.jsx(O,{idx:e,nameClassName:"hidden md:inline-block"}),filterFn:"equals",meta:{filterVariant:"select",showFacetedOccurrences:!0}},{id:"friendly_name",size:250,minSize:175,header:t(e=>e.friendly_name,{ns:"common"}),accessorFn:({device:e})=>`${e.friendly_name} ${e.ieee_address} ${e.definition?.model??""}`,cell:({row:{original:{sourceIdx:e,device:s}}})=>n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx("div",{className:"avatar",children:n.jsx("div",{className:"h-11 w-11",style:{overflow:"visible"},children:n.jsx(ne,{device:s,disabled:s.disabled})})}),n.jsxs("div",{className:"flex-grow flex flex-col min-w-0",children:[n.jsx(G,{to:`/device/${e}/${s.ieee_address}/bind`,className:"link link-hover truncate",children:s.friendly_name}),s.description&&n.jsx("div",{className:"max-w-3xs text-xs opacity-50 truncate",title:s.description,children:s.description})]})]}),sortingFn:(e,s)=>e.original.device.friendly_name.localeCompare(s.original.device.friendly_name),filterFn:"includesString",meta:{filterVariant:"text",textFaceted:!0}},{id:"source_endpoint",size:110,header:t(e=>e.source_endpoint,{ns:"common"}),accessorFn:({rule:e})=>`${e.source.endpoint}`,filterFn:"includesString",meta:{filterVariant:"text"}},{id:"type",size:120,header:t(e=>e.type,{ns:"zigbee"}),accessorFn:({rule:e})=>t(s=>e.target.type==="group"?s.group:s.device,{ns:"zigbee"}),filterFn:"equals",meta:{filterVariant:"select",showFacetedOccurrences:!0}},{id:"destination",minSize:200,header:t(e=>e.destination,{ns:"common"}),accessorFn:({sourceIdx:e,rule:s})=>{if(s.target.type==="group"){const i=m[e].find(h=>h.id===s.target.id)?.friendly_name;return i||`${t(h=>h.unknown)}: ${s.target.id}`}const r=d[e].find(i=>i.ieee_address===s.target.ieee_address)?.friendly_name;return r||`${t(i=>i.unknown)}: ${s.target.ieee_address}`},filterFn:"includesString",meta:{filterVariant:"text",textFaceted:!0}},{id:"destination_endpoint",minSize:200,header:t(e=>e.destination_endpoint,{ns:"common"}),accessorFn:({rule:e})=>e.target.type==="group"?"N/A":`${e.target.endpoint}`,filterFn:"includesString",meta:{filterVariant:"text"}},{id:"clusters",minSize:200,header:t(e=>e.clusters,{ns:"common"}),accessorFn:({rule:e})=>e.clusters.join(", "),cell:({row:{original:{rule:e}}})=>n.jsx("div",{className:"flex flex-row flex-wrap gap-1",children:e.clusters.map(s=>n.jsx("span",{className:"badge badge-ghost badge-sm",children:s},s))}),filterFn:"includesString",meta:{filterVariant:"text"}},{id:"actions",size:110,cell:({row:{original:{sourceIdx:e,device:s,rule:r}}})=>n.jsxs("div",{className:"join join-horizontal",children:[n.jsx(j,{className:"btn btn-sm btn-square btn-outline btn-primary join-item",title:t(i=>i.bind,{ns:"common"}),onClick:async()=>await M.show(ce,{sourceIdx:e,device:s,devices:d[e],groups:m[e],rule:r,onApply:async i=>await y(e,i[0],i[1])}),children:n.jsx(A,{icon:H})}),r.isNew?null:n.jsx($,{title:t(i=>i.unbind,{ns:"common"}),className:"btn btn-sm btn-square btn-error btn-outline join-item",onClick:async()=>await y(e,"Unbind",r),modalDescription:t(i=>i.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:t(i=>i.cancel,{ns:"common"}),children:n.jsx(A,{icon:J})})]}),enableSorting:!1,enableColumnFilter:!1,enableGlobalFilter:!1}],[y,d,m,t]),C=le({id:"all-bindings",columns:R,data:D,visibleColumns:{source:L},sorting:[{id:"friendly_name",desc:!1},{id:"source_endpoint",desc:!1}],rowSelection:a,onRowSelectionChange:b});return n.jsxs(n.Fragment,{children:[n.jsx(Y,{children:n.jsx(re,{...C})}),n.jsxs("div",{className:"flex flex-row flex-wrap justify-center gap-2 mb-2",children:[L?n.jsx(se,{name:"source",label:t(e=>e.source,{ns:"common"}),value:c,onChange:e=>{e.target.validationMessage||(u(Number.parseInt(e.target.value,10)),f(null),v(""))},className:"select",children:z.map((e,s)=>n.jsx("option",{value:s,children:e},`${s}-${e}`))}):null,n.jsx(ie,{label:t(e=>e.device,{ns:"zigbee"}),devices:d[c]??[],value:l?.ieee_address??"",onChange:e=>{e&&"ieee_address"in e?(f(e),v("")):f(null)},disabled:(d[c]??[]).length===0}),n.jsx(ae,{label:t(e=>e.source_endpoint,{ns:"common"}),values:k,value:w,disabled:!l,onChange:e=>v(String(e))}),l&&p?n.jsx(q,{sourceIdx:c,device:l,devices:d[c]??[],groups:m[c]??[],rule:p,onApply:F,showDivider:!1}):null]}),n.jsx("div",{className:"mb-5",children:n.jsxs("div",{className:"flex flex-row flex-wrap gap-2 px-2 pb-3",children:[n.jsx(j,{className:"btn btn-outline btn-error btn-sm",title:t(e=>e.bind_selected,{ns:"common"}),onClick:async()=>await M.show(de,{devices:d,selectedRows:C.table.getFilteredRowModel().rows.filter(e=>e.getIsSelected()),onApply:S}),disabled:x===0,children:`${t(e=>e.bind_selected,{ns:"common"})} (${x})`}),n.jsx($,{item:[!0,void 0],className:"btn btn-outline btn-error btn-sm",onClick:S,title:t(e=>e.unbind_selected,{ns:"common"}),disabled:x===0,modalDescription:t(e=>e.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:t(e=>e.cancel,{ns:"common"}),children:`${t(e=>e.unbind_selected,{ns:"common"})} (${x})`}),n.jsx($,{item:!1,className:"btn btn-outline btn-error btn-sm",onClick:N,title:t(e=>e.clear_self_as_source,{ns:"common"}),disabled:x===0,modalDescription:t(e=>e.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:t(e=>e.cancel,{ns:"common"}),children:`${t(e=>e.clear_self_as_source,{ns:"common"})} (${x})`}),n.jsx($,{item:!0,className:"btn btn-outline btn-error btn-sm",onClick:N,title:t(e=>e.clear_all,{ns:"common"}),disabled:x===0,modalDescription:t(e=>e.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:t(e=>e.cancel,{ns:"common"}),children:`${t(e=>e.clear_all,{ns:"common"})} (${x})`})]})}),n.jsx("div",{className:"mb-5",children:n.jsx(oe,{id:"all-bindings",...C})})]})}export{ke as default};
