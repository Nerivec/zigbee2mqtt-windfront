import{r as c,u as N,j as l,y as E,aR as v,a7 as w,B,F as x,J as D,a5 as S,aa as k}from"./index-DTLwKrFY.js";import{S as M}from"./react-select.esm-Bdw18Log.js";import{D as R}from"./DevicePicker-BoDg6RDG.js";import{E as $}from"./EndpointPicker-BBdFdL_6.js";const z=(e,r)=>({isNew:!0,target:{type:"endpoint",ieee_address:"",endpoint:""},source:{ieee_address:e,endpoint:r},clusters:[]}),U=e=>{const r={};for(const a in e.endpoints){const d=e.endpoints[a];for(const n of d.bindings){let o="ieee_address"in n.target?`${n.target.ieee_address}-${n.target.endpoint}`:n.target.id;o=`${o}-${a}`,r[o]?r[o].clusters.push(n.cluster):r[o]={source:{ieee_address:e.ieee_address,endpoint:a},target:{...n.target},clusters:[n.cluster]}}}return Object.values(r)},q=e=>{const r=[];for(const a in e.endpoints){const d=e.endpoints[a],n={};for(const o of d.bindings){const u="ieee_address"in o.target?`${o.target.ieee_address}-${o.target.endpoint}`:`group-${o.target.id}`;n[u]?n[u].clusters.push(o.cluster):n[u]={source:{ieee_address:e.ieee_address,endpoint:a},target:{...o.target},clusters:[o.cluster]}}r.push({endpointId:a,rules:Object.values(n)})}return r},T=(e,r,a)=>{const d=new Set(e.clusters),n=r[e.source.endpoint],o=e.target.type==="endpoint"&&e.target.endpoint!=null?a?.endpoints[e.target.endpoint]:void 0,u=e.target.type==="group"||a?.type==="Coordinator";if(n&&(o||u))for(const s of[...n.clusters.input,...n.clusters.output])if(u)d.add(s);else{const g=n.clusters.input.includes(s)&&o?.clusters.output.includes(s),i=n.clusters.output.includes(s)&&o?.clusters.input.includes(s);(g||i||u)&&d.add(s)}return d},G=(e,r,a)=>{if(e.type==="group"){const n=a.find(o=>o.id===e.id);if(!n){console.error("Target group does not exist:",e.id);return}return{to:n.id}}const d=r.find(n=>n.ieee_address===e.ieee_address);if(!d){console.error("Target device does not exist:",e.ieee_address);return}return{to:d.ieee_address,toEndpoint:d.type!=="Coordinator"?e.endpoint:void 0}},A=e=>!(!Array.isArray(e)||e.length===0),I=e=>{if(e.source.endpoint===void 0||e.source.endpoint===""||Number.isNaN(e.source.endpoint))return!1;if(e.target.type==="endpoint"){if(!e.target.ieee_address||e.target.endpoint===void 0||e.target.endpoint===""||Number.isNaN(e.target.endpoint))return!1}else if(e.target.type==="group"&&(e.target.id===void 0||Number.isNaN(e.target.id)))return!1;return A(e.clusters)},L=c.memo(({clusters:e,onChange:r,label:a,value:d,disabled:n,required:o})=>{const{t:u}=N("zigbee"),s=c.useMemo(()=>{const i=[];for(const f of e)i.push({label:f,value:f});return i.sort((f,b)=>f.label.localeCompare(b.label)),i},[e]),g=c.useMemo(()=>d==null?[]:s.filter(i=>d.includes(i.value)),[d,s]);return l.jsxs("fieldset",{className:"fieldset",children:[a&&l.jsxs("legend",{className:"fieldset-legend",children:[a,o?" *":""]}),l.jsx(M,{unstyled:!0,placeholder:u(i=>i.select_cluster),"aria-label":a??u(i=>i.select_cluster),options:s,value:g,isMulti:!0,hideSelectedOptions:!0,isSearchable:!0,isDisabled:n,onChange:i=>{r(i.map(f=>f.value))},className:"min-w-64",classNames:E})]})}),J=c.memo(({devices:e,groups:r,device:a,rule:d,onApply:n,showDivider:o,hideUnbind:u=!1})=>{const[s,g]=c.useState(d),{t:i}=N(["common","zigbee"]);c.useEffect(()=>{g(d)},[d]);const f=c.useCallback(t=>{if(!t)return;const p=v(t)?{type:"endpoint",ieee_address:t.ieee_address,endpoint:""}:{type:"group",id:t.id};g(y=>({...y,target:p,clusters:[]}))},[]),b=c.useCallback(t=>{s.target.type==="endpoint"&&g(p=>({...p,target:{...p.target,endpoint:t},clusters:[]}))},[s.target.type]),h=c.useCallback(t=>{g(p=>({...p,clusters:t}))},[]),m=c.useMemo(()=>{const{target:t}=s;return t.type==="group"?r.find(p=>p.id===t.id):e.find(p=>p.ieee_address===t.ieee_address)},[s,e,r]),j=c.useMemo(()=>w(m),[m]),C=c.useMemo(()=>T(s,a.endpoints,m),[a.endpoints,s,m]),_=c.useMemo(()=>I(s),[s]);return l.jsxs(l.Fragment,{children:[l.jsxs("div",{className:"flex flex-row flex-wrap gap-2",children:[l.jsx(R,{label:i(t=>t.destination),disabled:!s.isNew,value:"ieee_address"in s.target?s.target.ieee_address:s.target.id,devices:e,groups:r,onChange:f,required:!0}),s.target.type==="endpoint"?l.jsx($,{label:i(t=>t.destination_endpoint),disabled:!s.isNew,values:j,value:s.target.endpoint,onChange:b}):l.jsx("div",{className:"w-32"}),l.jsx("div",{className:"grow w-128",children:l.jsx(L,{label:i(t=>t.clusters),clusters:C,value:s.clusters,onChange:h})}),l.jsxs("fieldset",{className:"fieldset ml-auto",children:[l.jsx("legend",{className:"fieldset-legend",children:i(t=>t.actions)}),l.jsxs("div",{className:"join join-horizontal",children:[l.jsxs(B,{item:["Bind",s],disabled:!_,title:i(t=>t.bind),className:"btn btn-primary btn-outline join-item",onClick:n,children:[l.jsx(x,{icon:D}),i(t=>t.bind)," "]}),!u&&!s.isNew?l.jsxs(S,{item:["Unbind",s],disabled:!_,title:i(t=>t.unbind),className:"btn btn-error btn-outline join-item",onClick:n,modalDescription:i(t=>t.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:i(t=>t.cancel,{ns:"common"}),children:[l.jsx(x,{icon:k})," ",i(t=>t.unbind)]}):null]})]})]}),o?l.jsx("div",{className:"divider my-0"}):null]})});export{J as B,L as C,U as a,q as b,T as f,G as g,A as i,z as m};
