import{r,j as e,an as ee,a as L,D as R,aU as se,u as B,F as O,aV as K,ap as G,aW as J,K as W,B as P,X as te,a7 as ne,a5 as V,y as ae,s as U,aX as le,L as Y,aY as re,aZ as oe}from"./index-DTLwKrFY.js";import{T as Z}from"./TextareaField-DlAGnMTm.js";import{J as ie}from"./Json-BLX7Iwfr.js";import{D as g,C as H,A as ce,a as ue,B as de}from"./ClusterSinglePicker-DpCdk6e3.js";import{I as X}from"./InputField-fj8dQezf.js";import{E as me}from"./EndpointPicker-BBdFdL_6.js";import{S as pe}from"./react-select.esm-Bdw18Log.js";import"./envs-CRUy-_iG.js";import"./SelectField-Hd9BNgRL.js";import"./defineProperty-CegpTSss.js";import"./extends-CF3RwP-h.js";import"./floating-ui.dom-BSrWR8Gl.js";const Q=r.memo(({message:l})=>e.jsx("div",{className:"mockup-code w-full before:content-none",children:e.jsx("pre",{"data-prefix":"~",className:ee[l.level],children:e.jsxs("code",{children:["[",l.timestamp,"] ",l.message]})})})),xe=l=>{switch(l){case g.ARRAY:case g.SET:case g.BAG:return'{"elementType": TODO, "elements": [TODO]}';case g.STRUCT:return'[{"elmType": TODO, "elmVal": TODO}]';case g.TOD:return'{"hours": TODO, "minutes": TODO, "seconds": TODO, "hundredths": TODO}';case g.DATE:return'{"year": TODO, "month": TODO, "dayOfMonth": TODO, "dayOfWeek": TODO}';case g.SEC_KEY:return"[TODO]"}};function fe({value:l,onChange:n,attribute:i,definition:a}){if(a.type===g.ARRAY||a.type===g.STRUCT||a.type===g.SET||a.type===g.BAG||a.type===g.TOD||a.type===g.DATE||a.type===g.SEC_KEY)return e.jsx("input",{type:"text",className:"flex-1 input",value:l!=null&&l!==""?typeof l=="object"?JSON.stringify(l):l:void 0,placeholder:xe(a.type),onChange:f=>{n(i,f.target.value)},onBlur:f=>{if(f.target.value){const u=JSON.parse(f.target.value);n(i,u)}},disabled:!a.write});const x=a.type===g.IEEE_ADDR||a.type>=g.OCTET_STR&&a.type<=g.LONG_CHAR_STR?"text":"number";return e.jsx("input",{type:x,value:l==null||typeof l=="string"||typeof l=="number"?l:void 0,min:a.minExcl?a.minExcl+1:a.min,max:a.maxExcl?a.maxExcl-1:a.max,minLength:a.minLen??a.length,maxLength:a.maxLen??a.length,onChange:f=>{const u=x==="number"?f.target.valueAsNumber:f.target.value;n(i,Number.isNaN(u)?void 0:u)},disabled:!a.write,className:"flex-1 input validator"})}const ge=r.memo(({sourceIdx:l,device:n,read:i,write:a,readReporting:x,lastLog:f})=>{const u=L(R(t=>t.bridgeDefinitions[l])),[h,C]=r.useState(se(n.endpoints)??""),[b,_]=r.useState(""),[c,j]=r.useState([]),[d,D]=r.useState(""),{t:p}=B(["common","zigbee","devConsole"]),o=r.useCallback(t=>{_(""),j([]),C(t.toString())},[]),N=r.useCallback(t=>{j([]),_(t)},[]),T=r.useCallback((t,M)=>{if(!c.find(S=>S.attribute===t)){const S=c.concat([{attribute:t,definition:M}]);j(S)}},[c]),s=r.useCallback(t=>{D(t.target.value)},[]),m=r.useCallback(async()=>{await i(h,b,c.map(t=>t.attribute),d)},[h,b,c,d,i]),A=r.useCallback(async()=>{await a(h,b,c)},[h,b,c,a]),z=r.useCallback(async()=>{await x(h,b,c.map(t=>({attribute:t.attribute})))},[h,b,c,x]),k=r.useMemo(()=>c.length>0&&e.jsx("fieldset",{className:"fieldset gap-1 p-3 bg-base-200 rounded-box shadow-md border border-base-300 w-full",children:c.map(({attribute:t,value:M="",definition:S})=>e.jsxs("div",{className:"w-full flex flex-row items-center rounded-box p-1.5 hover:bg-base-100",children:[e.jsxs("div",{className:"flex-1 self-center text-[0.85rem] flex flex-row items-center gap-1",children:[t," (",g[S.type],")",S.required?null:e.jsx("span",{className:"tooltip tooltip-right","data-tip":p(w=>w.attribute_not_required,{ns:"zigbee"}),children:e.jsx(O,{icon:K,className:"text-warning"})}),S.read===!1?e.jsx("span",{className:"tooltip tooltip-right","data-tip":p(w=>w.attribute_not_readable,{ns:"zigbee"}),children:e.jsx(O,{icon:G,className:"text-error"})}):null,S.write?null:e.jsx("span",{className:"tooltip tooltip-right","data-tip":p(w=>w.attribute_not_writable,{ns:"zigbee"}),children:e.jsx(O,{icon:J,className:"text-error"})}),S.report?null:e.jsx("span",{className:"tooltip tooltip-right","data-tip":p(w=>w.attribute_report_not_required,{ns:"zigbee"}),children:e.jsx(O,{icon:W,className:"text-warning"})})]}),e.jsx(P,{className:"btn btn-error btn-outline mx-2",item:t,onClick:w=>{const v=c.filter(q=>q.attribute!==w);j(v)},children:e.jsx(O,{icon:te})}),e.jsx(fe,{value:M,attribute:t,definition:S,onChange:(w,v)=>{const q=Array.from(c),E=q.find(I=>I.attribute===w);E&&(E.value=v),j(q)}})]},t))}),[c,p]),$=r.useMemo(()=>{const t=new Set,M=new Set,S=new Set;if(h){const w=n.endpoints[Number.parseInt(h,10)],v=new Set;if(u.custom_clusters[n.ieee_address])for(const E in u.custom_clusters[n.ieee_address])v.has(E)||(v.add(E),M.add(E));if(w)for(const E of w.clusters.input)v.has(E)||(v.add(E),t.add(E));for(const E in u.clusters)v.has(E)||S.add(E)}return[{name:"custom_clusters",clusters:M},{name:"input_clusters",clusters:t},{name:"other_zcl_clusters",clusters:S}]},[n,h,u]),F=c.length===0||b==="",y=r.useMemo(()=>ne(n),[n]);return h?e.jsxs("div",{className:"flex-1 flex flex-col gap-3 w-full",children:[e.jsx("h2",{className:"text-lg",children:p(t=>t.read_write_attributes,{ns:"zigbee"})}),e.jsxs("div",{className:"flex flex-row flex-wrap gap-2",children:[e.jsx(me,{label:p(t=>t.endpoint,{ns:"zigbee"}),values:y,value:h,onChange:o,required:!0}),e.jsx(H,{label:p(t=>t.cluster),clusters:$,value:b,onChange:N,required:!0}),e.jsx(ce,{sourceIdx:l,label:p(t=>t.attribute),value:"",cluster:b,device:n,onChange:T}),e.jsx(X,{type:"text",name:"state_property",label:p(t=>t.state_property,{ns:"devConsole"}),value:d,detail:`${p(t=>t.optional)}. ${p(t=>t.state_property_info,{ns:"devConsole"})}`,onChange:s})]}),k,e.jsxs("div",{className:"w-full flex flex-row flex-wrap justify-between gap-2",children:[e.jsxs("div",{className:"w-full flex flex-row justify-between",children:[e.jsxs(P,{disabled:F||c.some(t=>t.definition.read===!1||t.value!=null&&t.value!==""),className:"btn btn-success",onClick:m,children:[e.jsx(O,{icon:G}),p(t=>t.read)]}),e.jsxs(P,{disabled:F||c.some(t=>!t.definition.write),className:"btn btn-error",onClick:A,children:[e.jsx(O,{icon:J}),p(t=>t.write)]})]}),e.jsxs(V,{disabled:F||c.some(t=>t.value!=null&&t.value!==""),className:"btn btn-accent",onClick:z,title:p(t=>t.sync_reporting),modalDescription:p(t=>t.dialog_confirmation_prompt),modalCancelLabel:p(t=>t.cancel),children:[e.jsx(O,{icon:W}),p(t=>t.sync_reporting)]})]}),f&&e.jsx(Q,{message:f})]}):e.jsx("span",{children:"No endpoints"})}),be=r.memo(({sourceIdx:l,cluster:n,device:i,onChange:a,value:x,label:f,required:u,disabled:h})=>{const C=L(R(d=>d.bridgeDefinitions[l])),{t:b}=B("zigbee"),_=r.useMemo(()=>ue(C,i.ieee_address,n),[C,i.ieee_address,n]),c=r.useMemo(()=>{const d=[];for(const D in _)d.push({value:D,label:D});return d},[_]),j=r.useMemo(()=>x==null||x===""?null:c.find(d=>d.value===x)??null,[x,c]);return e.jsxs("fieldset",{className:"fieldset",children:[f&&e.jsxs("legend",{className:"fieldset-legend",children:[f,u?" *":""]}),e.jsx(pe,{unstyled:!0,placeholder:b(d=>d.select_command),"aria-label":f??b(d=>d.select_command),options:c,value:j,isSearchable:!0,isDisabled:h,onChange:d=>{d!=null&&a(d.value,_[d.value])},className:"min-w-64",classNames:ae})]})}),he=l=>{if(l){let n="[";for(const i of l){n+=`{${i.type}`;for(const a in i)a!=="type"&&(n+=` ${a}=${i[a]}`);n+="}"}return`${n}]`}},_e=r.memo(({sourceIdx:l,device:n,lastLog:i})=>{const{t:a}=B(["common","zigbee"]),[x,f]=r.useState(1),[u,h]=r.useState(""),[C,b]=r.useState(""),[_,c]=r.useState(null),[j,d]=r.useState("{}"),D=L(R(s=>s.bridgeDefinitions[l])),p=r.useMemo(()=>{if(!u||!C)return!1;try{const s=JSON.parse(j);if(typeof s!="object"||Array.isArray(s)&&s.length>0&&typeof s[0]!="object")return!1}catch{return!1}return!0},[j,u,C]),o=r.useMemo(()=>{const s=n.endpoints[x],m=new Set,A=new Set,z=new Set,k=new Set,$=new Set;if(D.custom_clusters[n.ieee_address])for(const y in D.custom_clusters[n.ieee_address])m.has(y)||(m.add(y),k.add(y));if(s){for(const y of s.clusters.input)m.has(y)||(m.add(y),A.add(y));for(const y of s.clusters.output)m.has(y)||(m.add(y),z.add(y))}for(const y in D.clusters)m.has(y)||$.add(y);return[{name:"custom_clusters",clusters:k},{name:"input_clusters",clusters:A},{name:"output_clusters",clusters:z},{name:"other_zcl_clusters",clusters:$}]},[n.ieee_address,n.endpoints,x,D]),N=r.useCallback((s,m)=>{b(s),c(m);let A=`{
`;const z=m.parameters.length-1;for(let k=0;k<m.parameters.length;k++){const $=m.parameters[k];A+=`    "${$.name}": TODO${k===z?"":","}
`}A+="}",d(A)},[]),T=r.useCallback(async()=>{let s=Number.parseInt(C,10);Number.isNaN(s)&&(s=C),await U(l,`${n.ieee_address}/${x}/set`,{command:{cluster:u,command:s,payload:JSON.parse(j)}})},[l,u,n.ieee_address,C,j,x]);return e.jsxs("div",{className:"flex-1 flex flex-col gap-3 w-full",children:[e.jsx("h2",{className:"text-lg",children:a(s=>s.execute_command)}),e.jsxs("div",{className:"flex flex-row flex-wrap gap-2",children:[e.jsx(X,{type:"number",name:"endpoint",label:a(s=>s.endpoint,{ns:"zigbee"}),min:1,max:255,value:x,onChange:s=>!!s.target.value&&f(s.target.valueAsNumber),required:!0}),e.jsx(H,{label:a(s=>s.cluster,{ns:"zigbee"}),clusters:o,value:u,onChange:s=>{h(s)},required:!0}),e.jsx(be,{sourceIdx:l,label:a(s=>s.command),value:C,cluster:u,device:n,onChange:N})]}),_?e.jsxs("div",{className:"list",children:[_.required&&_.response==null?null:e.jsx("div",{className:"list-row p-1",children:e.jsxs("div",{className:"flex flex-row gap-2",children:[_.required?null:e.jsx("span",{className:"tooltip tooltip-right","data-tip":a(s=>s.command_not_required,{ns:"zigbee"}),children:e.jsx(O,{icon:K,className:"text-warning"})}),_.response==null?null:e.jsx("span",{className:"tooltip tooltip-right","data-tip":a(s=>s.command_has_response,{ns:"zigbee"}),children:e.jsx(O,{icon:le,className:"text-accent"})})]})}),_.parameters.length>0?_.parameters.map(s=>e.jsxs("div",{className:"list-row p-1",children:[e.jsxs("div",{children:[s.name,": ",g[s.type]??de[s.type]]}),e.jsxs("div",{className:"flex flex-row gap-2 justify-end",children:[s.min!=null?e.jsxs("span",{children:["Min: ",s.min]}):null,s.minExcl!=null?e.jsxs("span",{children:["Min excl: ",s.minExcl]}):null,s.max!=null?e.jsxs("span",{children:["Max: ",s.max]}):null,s.maxExcl!=null?e.jsxs("span",{children:["Max excl: ",s.maxExcl]}):null,s.minLen!=null?e.jsxs("span",{children:["Min len: ",s.minLen]}):null,s.maxLen!=null?e.jsxs("span",{children:["Max len: ",s.maxLen]}):null,s.length!=null?e.jsxs("span",{children:["Length: ",s.length]}):null,s.special!=null?e.jsxs("span",{children:["Special: [",s.special.map(m=>`${m[0]}=${m[1]}`).join(" "),"]"]}):null,s.conditions!=null?e.jsxs("span",{children:["Conditions: ",he(s.conditions)]}):null]})]},s.name)):e.jsx(e.Fragment,{children:"NO PARAMETER"})]}):null,e.jsx(Z,{name:"payload",label:a(s=>s.payload),rows:(j.match(/\n/g)||"").length+1,value:j,onChange:s=>d(s.target.value),className:"textarea validator w-full",required:!0,disabled:_?.parameters.length===0}),e.jsx("div",{children:e.jsx(P,{onClick:T,disabled:!p,className:"btn btn-success",children:a(s=>s.execute)})}),i&&e.jsx(Q,{message:i})]})}),je=r.memo(({sourceIdx:l,device:n,externalDefinition:i})=>{const{t:a}=B("zigbee"),x=L(R(u=>u.bridgeInfo[l])),f={template:"new_device_support.yaml",title:`[New device support]: ${n.model_id} from ${n.manufacturer}`,z2m_version:`${x.version} (${x.commit})`,notes:`
software_build_id: \`${n.software_build_id}\`
date_code: \`${n.date_code}\`
endpoints:
\`\`\`json
${JSON.stringify(n.endpoints)}
\`\`\``,external_definition:i};return e.jsx(Y,{target:"_blank",rel:"noopener noreferrer",to:`${oe}?${new URLSearchParams(f).toString()}`,className:"btn",children:a(u=>u.request_support)})}),ye=/^(zhc:tz: Read result of |z2m: Publish 'set' 'read' to |z2m: Publish 'set' 'write' to |zhc:tz: Wrote )/;function Re({sourceIdx:l,device:n}){const{t:i}=B(["devConsole","common"]),a=L(R(o=>o.generatedExternalDefinitions[l][n.ieee_address])),x=L(R(o=>o.logs[l].findLast(N=>N.message.startsWith("zhc:tz: Invoked ")))),f=L(R(o=>o.logs[l].findLast(N=>ye.test(N.message)))),u=L(o=>o.resetDeviceState),[h,C]=r.useState(!1),[b,_]=r.useState(!1);r.useEffect(()=>{C(!1)},[n]);const c=r.useCallback(async(o,N,T,s)=>{const m={read:{cluster:N,attributes:T}};s&&(m.read.state_property=s),await U(l,`${n.ieee_address}/${o}/set`,m)},[l,n.ieee_address]),j=r.useCallback(async(o,N,T)=>{const s={write:{cluster:N,payload:{}}};for(const m of T)s.write.payload[m.attribute]=m.value;await U(l,`${n.ieee_address}/${o}/set`,s)},[l,n.ieee_address]),d=r.useCallback(async(o,N,T)=>{await U(l,"bridge/request/device/reporting/read",{id:n.ieee_address,endpoint:o,cluster:N,configs:T})},[l,n.ieee_address]),D=r.useCallback(async()=>{C(!0),await U(l,"bridge/request/device/generate_external_definition",{id:n.ieee_address})},[l,n.ieee_address]),p=r.useCallback(()=>{u(l,n.friendly_name)},[l,n.friendly_name,u]);return e.jsxs("div",{className:"flex flex-col gap-3 w-full",children:[e.jsxs("div",{className:"flex flex-row flex-wrap justify-center items-center gap-2",children:[a?n.supported?null:e.jsx(je,{sourceIdx:l,device:n,externalDefinition:a}):h?e.jsx("span",{className:"loading loading-infinity loading-xl"}):e.jsx(P,{className:"btn btn-primary",onClick:D,children:i(o=>o.generate_external_definition)}),e.jsx(P,{item:!b,onClick:_,className:"btn btn-primary",children:i(o=>b?o.hide_definition:o.show_definition)}),e.jsx(V,{className:"btn btn-error",onClick:p,title:i(o=>o.reset_frontend_state),modalDescription:i(o=>o.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:i(o=>o.cancel,{ns:"common"}),children:i(o=>o.reset_frontend_state)})]}),a&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divider"}),e.jsx(Z,{name:"generated_external_definition",label:i(o=>o.generated_external_definition),value:a,className:"textarea w-full",rows:8,readOnly:!0}),e.jsx(Y,{to:re,target:"_blank",rel:"noreferrer",className:"link link-primary self-end",children:i(o=>o.documentation,{ns:"common"})})]}),b&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divider"}),e.jsx(ie,{obj:n.definition??{},lines:12})]}),e.jsx("div",{className:"divider"}),e.jsx(ge,{sourceIdx:l,device:n,read:c,write:j,readReporting:d,lastLog:f}),e.jsx("div",{className:"divider"}),e.jsx(_e,{sourceIdx:l,device:n,lastLog:x})]})}export{Re as default};
