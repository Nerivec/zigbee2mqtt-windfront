import{r as o,j as e,a3 as J,aA as W,b as $,C as v,F as V,G as K,aw as X,a as k,k as A,c as D,T as Z,L as M,aB as H,aC as Y}from"./index-BFQ_Rrcw.js";import{T as U}from"./TextareaField-CbVtSljh.js";import{J as I}from"./Json-Bo8BBs-S.js";import{I as q}from"./InputField-CIKw2Xrr.js";import{C as F,A as Q}from"./ClusterSinglePicker-DujI1Kk6.js";import{E as ee}from"./EndpointPicker-B4Z6Kw3O.js";import"./envs-CSqIi4cL.js";import"./SelectField-CyWoaAVb.js";const B=o.memo(({message:r})=>e.jsx("div",{className:"mockup-code w-full",children:e.jsx("pre",{"data-prefix":"~",className:J[r.level],children:e.jsxs("code",{children:["[",r.timestamp,"] ",r.message]})})})),te=[65,66,67,68];function se({value:r,onChange:s,attribute:i,definition:c,...m}){const d=te.includes(c.type)?"text":"number";return e.jsx("input",{type:d,value:r,onChange:u=>{const f=d==="number"?u.target.valueAsNumber:u.target.value;s(i,Number.isNaN(f)?void 0:f)},...m})}const ne=o.memo(({sourceIdx:r,device:s,readDeviceAttributes:i,writeDeviceAttributes:c,lastLog:m})=>{const[d,u]=o.useState(W(s.endpoints)??""),[f,g]=o.useState(""),[l,b]=o.useState([]),[w,C]=o.useState(""),{t:x}=$(["common","zigbee","devConsole"]),E=o.useCallback(n=>{g(""),b([]),u(n.toString())},[]),a=o.useCallback(n=>{b([]),g(n)},[]),t=o.useCallback((n,S)=>{if(!l.find(N=>N.attribute===n)){const N=l.concat([{attribute:n,definition:S}]);b(N)}},[l]),_=o.useCallback(n=>{C(n.target.value)},[]),y=o.useCallback(async()=>{await i(s.ieee_address,d,f,l.map(n=>n.attribute),w)},[s.ieee_address,d,f,l,w,i]),h=o.useCallback(async()=>{await c(s.ieee_address,d,f,l)},[s.ieee_address,d,f,l,c]),j=o.useMemo(()=>l.length>0&&e.jsx("fieldset",{className:"fieldset gap-2 p-3 bg-base-200 rounded-box shadow-md border border-base-300",children:l.map(({attribute:n,value:S="",definition:N})=>e.jsxs("div",{className:"join join-horizontal min-w-xs",children:[e.jsxs("label",{className:"input join-item",children:[n,e.jsx(se,{value:S,attribute:n,definition:N,onChange:(T,R)=>{const L=Array.from(l),O=L.find(G=>G.attribute===T);O&&(O.value=R),b(L)}})]}),e.jsx(v,{className:"btn btn-error btn-outline join-item",item:n,onClick:T=>{const R=l.filter(L=>L.attribute!==T);b(R)},children:e.jsx(V,{icon:K})})]},n))}),[l]),z=o.useMemo(()=>{const n=new Set;if(d){const S=s.endpoints[Number.parseInt(d,10)];if(S)for(const N of S.clusters.input)n.add(N)}return n},[s,d]),P=l.length===0||f==="",p=o.useMemo(()=>X(s),[s]);return d?e.jsxs("div",{className:"flex-1 flex flex-col gap-3 w-full",children:[e.jsx("h2",{className:"text-lg",children:x(n=>n.read_write_attributes,{ns:"zigbee"})}),e.jsxs("div",{className:"flex flex-row flex-wrap gap-2",children:[e.jsx(ee,{label:x(n=>n.endpoint,{ns:"zigbee"}),values:p,value:d,onChange:E,required:!0}),e.jsx(F,{label:x(n=>n.cluster),clusters:z,value:f,onChange:a,required:!0}),e.jsx(Q,{sourceIdx:r,label:x(n=>n.attribute),value:"",cluster:f,device:s,onChange:t}),e.jsx(q,{type:"text",name:"state_property",label:x(n=>n.state_property,{ns:"devConsole"}),value:w,detail:`${x(n=>n.optional)}. ${x(n=>n.state_property_info,{ns:"devConsole"})}`,onChange:_})]}),j,e.jsxs("div",{className:"join join-horizontal",children:[e.jsx(v,{disabled:P||l.some(n=>!!n.value),className:"btn btn-success join-item",onClick:y,children:x(n=>n.read)}),e.jsx(v,{disabled:P,className:"btn btn-error join-item",onClick:h,children:x(n=>n.write)})]}),m&&e.jsx(B,{message:m})]}):e.jsx("span",{children:"No endpoints"})}),ae=o.memo(({sourceIdx:r,device:s,lastLog:i})=>{const{t:c}=$(["common","zigbee"]),[m,d]=o.useState(1),[u,f]=o.useState(""),[g,l]=o.useState(""),[b,w]=o.useState("{}"),C=k(A(t=>t.bridgeDefinitions[r])),x=o.useMemo(()=>{if(!u||!g)return!1;try{const t=JSON.parse(b);if(typeof t!="object"||Array.isArray(t)&&t.length>0&&typeof t[0]!="object")return!1}catch{return!1}return!0},[b,u,g]),E=o.useMemo(()=>{const t=s.endpoints[m],_=new Set,y=new Set,h=new Set,j=new Set,z=new Set;if(t){for(const p of t.clusters.input)_.add(p),y.add(p);for(const p of t.clusters.output)_.add(p),h.add(p)}if(C.custom_clusters[s.friendly_name])for(const p in C.custom_clusters[s.friendly_name])_.has(p)||(_.add(p),j.add(p));for(const p in C.clusters)_.has(p)||z.add(p);return[{name:"input_clusters",clusters:y},{name:"output_clusters",clusters:h},{name:"custom_clusters",clusters:j},{name:"other_zcl_clusters",clusters:z}]},[s.friendly_name,s.endpoints,m,C]),a=o.useCallback(async()=>{let t=Number.parseInt(g,10);Number.isNaN(t)&&(t=g),await D(r,`${s.ieee_address}/${m}/set`,{command:{cluster:u,command:t,payload:JSON.parse(b)}})},[r,u,s.ieee_address,g,b,m]);return e.jsxs("div",{className:"flex-1 flex flex-col gap-3 w-full",children:[e.jsx("h2",{className:"text-lg",children:c(t=>t.execute_command)}),e.jsxs("div",{className:"flex flex-row flex-wrap gap-2",children:[e.jsx(q,{type:"number",name:"endpoint",label:c(t=>t.endpoint,{ns:"zigbee"}),min:1,max:255,value:m,onChange:t=>!!t.target.value&&d(t.target.valueAsNumber),required:!0}),e.jsx(F,{label:c(t=>t.cluster,{ns:"zigbee"}),clusters:E,value:u,onChange:t=>{f(t)},required:!0}),e.jsx(q,{type:"text",name:"command",label:c(t=>t.command),value:g,placeholder:"state, color...",onChange:t=>l(t.target.value),pattern:"^\\d+|^\\w+",required:!0})]}),e.jsx(U,{name:"payload",label:c(t=>t.payload),rows:3,value:b,onChange:t=>w(t.target.value),className:"textarea validator w-full",required:!0}),e.jsx("div",{children:e.jsx(v,{onClick:a,disabled:!x,className:"btn btn-success",children:c(t=>t.execute)})}),i&&e.jsx(B,{message:i})]})}),oe=o.memo(({sourceIdx:r,device:s,externalDefinition:i})=>{const{t:c}=$("zigbee"),m=k(A(u=>u.bridgeInfo[r])),d={template:"new_device_support.yaml",title:`[New device support]: ${s.model_id} from ${s.manufacturer}`,z2m_version:`${m.version} (${m.commit})`,notes:`
software_build_id: \`${s.software_build_id}\`
date_code: \`${s.date_code}\`
endpoints:
\`\`\`json
${JSON.stringify(s.endpoints)}
\`\`\``,external_definition:i};return e.jsx(M,{target:"_blank",rel:"noopener noreferrer",to:`${Y}?${new URLSearchParams(d).toString()}`,className:"btn",children:c(u=>u.request_support)})}),re=/^(zhc:tz: Read result of |z2m: Publish 'set' 'read' to |z2m: Publish 'set' 'write' to |zhc:tz: Wrote )/;function be({sourceIdx:r,device:s}){const{t:i}=$(["devConsole","common"]),c=k(A(a=>a.generatedExternalDefinitions[r][s.ieee_address])),m=k(A(a=>a.logs[r].findLast(t=>t.message.startsWith("zhc:tz: Invoked ")))),d=k(A(a=>a.logs[r].findLast(t=>re.test(t.message)))),u=k(a=>a.resetDeviceState),[f,g]=o.useState(!1),[l,b]=o.useState(!1);o.useEffect(()=>{g(!1)},[s]);const w=o.useCallback(async(a,t,_,y,h)=>{const j={read:{cluster:_,attributes:y}};h&&(j.read.state_property=h),await D(r,`${a}/${t}/set`,j)},[r]),C=o.useCallback(async(a,t,_,y)=>{const h={write:{cluster:_,payload:{}}};for(const j of y)h.write.payload[j.attribute]=j.value;await D(r,`${a}/${t}/set`,h)},[r]),x=o.useCallback(async()=>{g(!0),await D(r,"bridge/request/device/generate_external_definition",{id:s.ieee_address})},[r,s.ieee_address]),E=o.useCallback(()=>{u(r,s.friendly_name)},[r,s.friendly_name,u]);return e.jsxs("div",{className:"flex flex-col gap-3 w-full",children:[e.jsxs("div",{className:"flex flex-row flex-wrap justify-center items-center gap-2",children:[c?s.supported?null:e.jsx(oe,{sourceIdx:r,device:s,externalDefinition:c}):f?e.jsx("span",{className:"loading loading-infinity loading-xl"}):e.jsx(v,{className:"btn btn-primary",onClick:x,children:i(a=>a.generate_external_definition)}),e.jsx(v,{item:!l,onClick:b,className:"btn btn-primary",children:i(a=>l?a.hide_definition:a.show_definition)}),e.jsx(Z,{className:"btn btn-error",onClick:E,title:i(a=>a.reset_frontend_state),modalDescription:i(a=>a.dialog_confirmation_prompt,{ns:"common"}),modalCancelLabel:i(a=>a.cancel,{ns:"common"}),children:i(a=>a.reset_frontend_state)})]}),c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divider"}),e.jsx(U,{name:"generated_external_definition",label:i(a=>a.generated_external_definition),value:c,className:"textarea w-full",rows:8,readOnly:!0}),e.jsx(M,{to:H,target:"_blank",rel:"noreferrer",className:"link link-primary self-end",children:i(a=>a.documentation,{ns:"common"})})]}),l&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"divider"}),e.jsx(I,{obj:s.definition??{},lines:12})]}),e.jsx("div",{className:"divider"}),e.jsxs("div",{className:"flex flex-row flex-wrap justify-evenly gap-4",children:[e.jsx(ne,{sourceIdx:r,device:s,readDeviceAttributes:w,writeDeviceAttributes:C,lastLog:d}),e.jsx(ae,{sourceIdx:r,device:s,lastLog:m})]})]})}export{be as default};
