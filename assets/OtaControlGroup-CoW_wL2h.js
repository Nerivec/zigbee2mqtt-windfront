import{r as o,u as O,j as e,ad as P,B as y,F as x,b2 as se,b3 as ne,f as re,am as ie,b4 as le,ae as oe,af as ce}from"./index-DTLwKrFY.js";import{u as ue,g as de,d as me,c as fe,e as pe,F as _e,f as ge,o as he,a as xe,s as be,b as we}from"./floating-ui.react-ey6TW0xJ.js";import{C as M}from"./CheckboxField-C_Qtx-pp.js";import{I as N}from"./InputField-fj8dQezf.js";import{S as je}from"./SelectField-Hd9BNgRL.js";const ye=new Uint8Array([30,241,238,11]),G=56,ve=a=>{if(a==null||a<0)return;const s=a.toString(16).padStart(8,"0"),n=`${s[0]}.${s[1]}`,r=Number.parseInt(s.slice(2,4),16),i=`${s[4]}.${s[5]}`,p=Number.parseInt(s.slice(6),16);return[n,r,i,p]};function ke(a,s,n){const i=(a instanceof ArrayBuffer?a:a.buffer.slice(a.byteOffset,a.byteOffset+a.byteLength)).slice(s,n);return new TextDecoder("utf-8").decode(i).replace(/\0+$/g,"").trimEnd()}function Ne(a,s){if(!s.length)return 0;for(let n=0;n<=a.length-s.length;n+=1)if(Se(a,s,n))return n;return-1}function Se(a,s,n){if(n<0||n+s.length>a.length)return!1;for(let r=0;r<s.length;r+=1)if(a[n+r]!==s[r])return!1;return!0}function Ue(a){const s=Ne(new Uint8Array(a),ye);if(s===-1)throw new Error("Invalid OTA file");const n=s>0?a.slice(s):a,r=new DataView(n);if(n.byteLength<G)throw new Error("Buffer too small to contain header");const i=new Uint8Array(n.slice(0,4)),p=r.getUint16(4,!0),b=r.getUint16(6,!0),g=r.getUint16(8,!0),c=r.getUint16(10,!0),A=r.getUint16(12,!0),v=r.getUint32(14,!0),C=r.getUint16(18,!0),k=ke(n,20,52),d=r.getUint32(52,!0);let m=G,_,w,l,j;if(g&1){if(m+1>n.byteLength)throw new Error("Unexpected end of buffer while reading securityCredentialVersion");_=r.getUint8(m),m+=1}if(g&2){if(m+8>n.byteLength)throw new Error("Unexpected end of buffer while reading upgradeFileDestination");w=new Uint8Array(n.slice(m,m+8)),m+=8}if(g&4){if(m+4>n.byteLength)throw new Error("Unexpected end of buffer while reading hardware versions");l=r.getUint16(m,!0),j=r.getUint16(m+2,!0)}return{otaUpgradeFileIdentifier:i,otaHeaderVersion:p,otaHeaderLength:b,otaHeaderFieldControl:g,manufacturerCode:c,imageType:A,fileVersion:v,zigbeeStackVersion:C,otaHeaderString:k,totalImageSize:d,securityCredentialVersion:_,upgradeFileDestination:w,minimumHardwareVersion:l,maximumHardwareVersion:j}}function Ae(a){return new Promise((s,n)=>{const r=new FileReader;r.onload=()=>{if(r.result instanceof ArrayBuffer)try{const i=Ue(r.result);let p="";for(const b of new Uint8Array(r.result))p+=b.toString(16).padStart(2,"0");s([p,i])}catch(i){n(i)}else n(new Error("Unexpected read result"))},r.onerror=()=>n(r.error??new Error("Unknown file read error")),r.readAsArrayBuffer(a)})}const Ce=o.memo(({settings:a,setSettings:s,defaultSettings:n})=>{const{t:r}=O("ota");return e.jsxs("div",{className:"flex flex-col gap-0 items-center",children:[e.jsx(N,{type:"number",name:"image_block_request_timeout",label:r(i=>i.image_block_request_timeout),min:1e4,max:2147483647,value:a.image_block_request_timeout??"",placeholder:`${n.image_block_request_timeout??15e4}`,onChange:i=>s({...a,image_block_request_timeout:i.target.value?i.target.valueAsNumber:void 0})}),e.jsx(N,{type:"number",name:"image_block_response_delay",label:r(i=>i.image_block_response_delay),min:50,value:a.image_block_response_delay??"",placeholder:`${n.image_block_response_delay??250}`,onChange:i=>s({...a,image_block_response_delay:i.target.value?i.target.valueAsNumber:void 0})}),e.jsx(N,{type:"number",name:"default_maximum_data_size",label:r(i=>i.default_maximum_data_size),min:10,max:100,value:a.default_maximum_data_size??"",placeholder:`${n.default_maximum_data_size??50}`,onChange:i=>s({...a,default_maximum_data_size:i.target.value?i.target.valueAsNumber:void 0})})]})}),J=o.memo(({version:a,showRaw:s})=>{const{t:n}=O("ota"),r=o.useMemo(()=>ve(a),[a]);return r===void 0?e.jsx("span",{children:"N/A"}):e.jsxs("div",{className:`flex flex-col ${s?"":"tooltip tooltip-top"}`,"data-tip":a,children:[e.jsxs("span",{children:[n(i=>i.app),": ",`${r[0]} build ${r[1]}`]}),e.jsxs("span",{children:[n(i=>i.stack),": ",`${r[2]} build ${r[3]}`]}),s?e.jsx("span",{className:"text-base-content/75",children:a}):null]})}),Re=o.memo(({sourceIdx:a,device:s,state:n,otaSettings:r,onCheckClick:i,onUpdateClick:p,onScheduleClick:b,onUnscheduleClick:g})=>{const{t:c}=O(["ota","common"]),A=s.interview_state===P.InProgress||s.interview_state===P.Pending||n?.state==="updating",v=s.definition?.supports_ota,C=n?.state==="scheduled",k=o.useRef(null),[d,m]=o.useState(v?"default":"custom_index"),[_,w]=o.useState(!1),[l,j]=o.useState(null),[f,S]=o.useState(null),[q,R]=o.useState(null),[$,K]=o.useState(null),[z,I]=o.useState(!1),[h,Q]=o.useState({}),D=o.useRef(null),[T,F]=o.useState(!1),{refs:V,floatingStyles:W,context:U}=ue({open:T,onOpenChange:F,middleware:[he(4),xe({padding:16,crossAxis:!0}),be({padding:16,crossAxis:!0}),we({element:D})]}),X=de(U,{event:"click"}),Y=me(U),Z=fe(U),{getReferenceProps:ee,getFloatingProps:te}=pe([X,Y,Z]);o.useEffect(()=>{w(!1),j(null),S(null),I(!1)},[d]);const E=o.useCallback(async t=>{switch(F(!1),t){case"check":{const u={sourceIdx:a,ieee:s.ieee_address,downgrade:_};l&&(u.url=l),await i(u);break}case"update":{const u={sourceIdx:a,ieee:s.ieee_address,downgrade:_};l&&(u.url=l),f&&(u.hex=f),h.image_block_request_timeout&&(u.image_block_request_timeout=h.image_block_request_timeout),h.image_block_response_delay&&(u.image_block_response_delay=h.image_block_response_delay),h.default_maximum_data_size&&(u.default_maximum_data_size=h.default_maximum_data_size),await p(u);break}case"schedule":{const u={sourceIdx:a,ieee:s.ieee_address,downgrade:_};l&&(u.url=l),f&&(u.hex=f),await b(u);break}case"unschedule":{await g({sourceIdx:a,ieee:s.ieee_address});break}}},[a,s.ieee_address,l,f,_,h,i,p,b,g]),ae=o.useMemo(()=>d==="custom_firmware"||d==="custom_index"&&(!l||!/.+\.json$/.test(l)),[d,l]),B=o.useMemo(()=>d==="custom_firmware"&&(!f&&!l||!!f&&!!l)||d==="custom_index"&&(!l||!/.+\.json$/.test(l)),[d,f,l]);return e.jsxs(e.Fragment,{children:[C?e.jsx(y,{className:"btn btn-sm btn-square btn-outline btn-error join-item",onClick:g,item:{sourceIdx:a,ieee:s.ieee_address},title:c(t=>t.unschedule),children:e.jsx(x,{icon:se})}):e.jsx("button",{ref:V.setReference,type:"button",className:"btn btn-sm btn-square btn-outline btn-primary join-item tooltip tooltip-top",...ee(),"data-tip":"OTA",disabled:A,children:e.jsx(x,{icon:ne})}),T?e.jsx(_e,{children:e.jsxs("aside",{ref:V.setFloating,style:W,...te({className:"card bg-base-200 shadow-lg border border-base-300 w-[min(32rem,calc(100vw-2.5rem))] max-h-[90vh] z-11"}),children:[e.jsxs("div",{className:"card-body py-2 w-full h-full overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"card-title",children:["OTA: ",s.friendly_name]}),e.jsx(y,{onClick:()=>F(!1),className:"btn btn-ghost btn-square",children:e.jsx(x,{icon:re})})]}),e.jsxs("div",{className:"flex flex-col gap-2 items-center w-full h-full overflow-y-auto",children:[n?.installed_version?e.jsx("ul",{className:"steps steps-horizontal w-full mb-2",children:e.jsx("li",{className:"step step-neutral","data-content":"●",children:e.jsx(J,{version:n.installed_version,showRaw:!0})})}):null,v?null:e.jsx("span",{className:"text-base-content/65",children:c(t=>t.no_official_ota_support)}),e.jsxs("div",{className:"flex flex-row flex-wrap gap-3 items-top",children:[e.jsxs(je,{name:"source_type",label:c(t=>t.source),onChange:t=>{m(t.target.value)},value:d,children:[v?e.jsx("option",{value:"default",children:c(t=>t.default)}):null,e.jsx("option",{value:"custom_index",children:c(t=>t.custom_index)}),e.jsx("option",{value:"custom_firmware",children:c(t=>t.custom_firmware)})]}),e.jsx(M,{name:"source_downgrade",label:c(t=>t.downgrade),onChange:t=>w(t.target.checked),checked:_}),e.jsx(M,{name:"show_update_settings",label:c(t=>t.show_update_settings),checked:z,onChange:t=>I(t.target.checked)})]}),_?e.jsx("p",{children:c(t=>t.downgrade_notice)}):null,z?e.jsx(Ce,{settings:h,setSettings:Q,defaultSettings:r}):null,e.jsx("div",{className:"flex flex-col w-full items-center",children:d==="default"?null:d==="custom_index"?e.jsx(N,{name:"source_url",type:"text",label:c(t=>t.source_url_index),onChange:t=>j(t.target.value?t.target.value:null),value:l||"",pattern:".+\\.json$",required:!0}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:`join join-horizontal items-center mt-2 ${f?"w-full":""}`,children:[e.jsx("input",{ref:k,name:"source_hex",type:"file",accept:"application/octet-stream,.zigbee,.ota,.bin",className:"file-input join-item flex-1",onChange:async t=>{const u=t.target.files?.[0];if(u)try{const[H,L]=await Ae(u);S({data:H,file_name:u.name||void 0}),R(L),n?.installed_version&&w(L.fileVersion<n.installed_version)}catch(H){S(null),R(null),K(H.message)}},disabled:!!l}),e.jsx(y,{item:a,onClick:()=>{S(null),k.current&&(k.current.value="")},className:"btn btn-square btn-outline btn-warning btn-primary join-item",disabled:!f,title:c(t=>t.clear,{ns:"common"}),children:e.jsx(x,{icon:ie})})]}),q?e.jsx("ul",{className:"steps steps-horizontal w-full mt-1",children:e.jsx("li",{className:"step step-primary","data-content":"★",children:e.jsx(J,{version:q.fileVersion,showRaw:!0})})}):$?e.jsx("p",{children:$}):null,e.jsx("div",{className:"divider mb-1",children:"OR"}),e.jsx(N,{name:"source_url",type:"text",label:c(t=>t.source_url_firmware),onChange:t=>j(t.target.value?t.target.value:null),value:l||"",readOnly:!!f})]})})]}),e.jsxs("div",{className:"card-actions justify-end py-2",children:[e.jsx(y,{className:"btn btn-square btn-outline btn-primary join-item",onClick:E,item:"check",title:c(t=>t.check),disabled:ae,children:e.jsx(x,{icon:le})}),e.jsx(y,{className:"btn btn-square btn-outline btn-error join-item",onClick:E,item:"update",title:c(t=>t.update),disabled:B,children:e.jsx(x,{icon:oe})}),e.jsx(y,{className:"btn btn-square btn-outline btn-info join-item",onClick:E,item:"schedule",title:c(t=>t.schedule),disabled:B,children:e.jsx(x,{icon:ce})})]})]}),e.jsx(ge,{ref:D,context:U,className:"fill-base-200 [&>path:first-of-type]:stroke-base-300 [&>path:last-of-type]:stroke-base-300"})]})}):null]})});export{J as O,Ce as a,Re as b,ve as f};
